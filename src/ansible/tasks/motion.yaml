---
- name: Install/upgrade motion/motioneye depenencies.
  become: yes
  apt:
    name:
      - ffmpeg 
      - libmariadb3
      - libpq5
      - libmicrohttpd12
      - python-pip
      - python-dev
      - python-pillow
      - libssl-dev
      - libcurl4-openssl-dev
      - libjpeg-dev
      - libz-dev
    state: latest

- name: Install/upgrade motion package.
  become: yes
  apt:
    deb: https://github.com/Motion-Project/motion/releases/download/release-4.3.2/pi_buster_motion_4.3.2-1_armhf.deb
  when: "'motion' not in ansible_facts.packages"
  notify: restart motioneye

  #- name: Ensure motion is enabled
  #  become: yes
  #  lineinfile:
  #    path: /etc/default/motion
  #    regexp: '^start_motion_daemon='
  #    line: 'start_motion_daemon=yes'
  #  notify: restart motion

  #- name: Install motion configuration.
  #  become: yes
  #  copy:
  #    src: motion.conf
  #    dest: /etc/motion/motion.conf
  #  notify: restart motion

- name: Install motioneye.
  become: yes
  pip:
    name: motioneye
    executable: /usr/bin/pip 

- name: Ensure motioneye config directory present.
  become: yes
  file:
    path: /etc/motioneye
    state: directory
    mode: '0755'

- name: Copy config for motioneye. 
  become: yes
  copy:
    src: files/motioneye.conf
    dest: /etc/motioneye/motioneye.conf
  notify: restart motioneye

- name: Copy config for motion. 
  become: yes
  copy:
    src: files/motion.conf
    dest: /etc/motioneye/motion.conf
  notify: restart motioneye

- name: Copy config for camera 1.
  become: yes
  copy:
    src: files/camera-1.conf
    dest: /etc/motioneye/camera-1.conf
  notify: restart motioneye

- name: Ensure motioneye media directory present.
  become: yes
  file:
    path: /var/lib/motioneye
    state: directory
    mode: '0755'

- name: Copy service script for motioneye. 
  become: yes
  copy:
    src: /usr/local/share/motioneye/extra/motioneye.systemd-unit-local
    dest: /etc/systemd/system/motioneye.service
    remote_src: yes
  notify: restart motioneye

- name: start motioneye service at 6am.
  become: yes
  cron:
    name: start motioneye service
    minute: 0
    hour: 6
    user: root
    job: "service motioneye start > /dev/null"

- name: stop motioneye service at 21pm.
  become: yes
  cron:
    name: stop motioneye service
    minute: 0
    hour: 21
    user: root
    job: "service motioneye stop > /dev/null"
